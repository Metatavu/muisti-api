<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">

    <changeSet id="exhibitions" author="antti.leppa">
        <createTable tableName="exhibition">
            <column name="id" type="binary(16)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="createdat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="modifiedat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="creatorid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
            <column name="lastmodifierid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="varchar(191)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="visitorsessions" author="antti.leppa">
        <createTable tableName="visitorsession">
            <column name="id" type="binary(16)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="createdat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="modifiedat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="creatorid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
            <column name="lastmodifierid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
            <column name="state" type="varchar(191)">
                <constraints nullable="false"/>
            </column>
            <column name="exhibition_id" type="binary(16)">
                <constraints nullable="false" foreignKeyName="FK_VISITORSESSION_EXHIBITION_ID" referencedColumnNames="id" referencedTableName="exhibition"/>
            </column>
        </createTable>

        <createTable tableName="visitorsessionvariable">
            <column name="id" type="binary(16)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="name" type="varchar(191)">
                <constraints nullable="false"/>
            </column>
            <column name="value" type="longtext">
                <constraints nullable="false"/>
            </column>
            <column name="visitorSession_id" type="binary(16)">
                <constraints nullable="false" foreignKeyName="FK_VISITOR_SESSION_VARIABLE_VISITORSESSION_ID" referencedColumnNames="id" referencedTableName="visitorsession"/>
            </column>
        </createTable>
        
        <createTable tableName="visitorsessionuser">
            <column name="id" type="binary(16)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="userId" type="binary(16)">
                <constraints nullable="false"/>
            </column>
            <column name="tagId" type="varchar(191)">
                <constraints nullable="false"/>
            </column>
            <column name="visitorSession_id" type="binary(16)">
                <constraints nullable="false" foreignKeyName="FK_VISITOR_SESSION_USER_VISITORSESSION_ID" referencedColumnNames="id" referencedTableName="visitorsession"/>
            </column>
        </createTable>

    </changeSet>

    <changeSet id="rooms" author="antti.leppa">
        <createTable tableName="exhibitionroom">
            <column name="id" type="binary(16)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="name" type="varchar(191)">
                <constraints nullable="false"/>
            </column>
            <column name="exhibition_id" type="binary(16)">
                <constraints nullable="false" foreignKeyName="FK_EXHIBITIONROOM_EXHIBITION_ID" referencedColumnNames="id" referencedTableName="exhibition"/>
            </column>
            <column name="createdat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="modifiedat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="creatorid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
            <column name="lastmodifierid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="devicegroups" author="antti.leppa">
        <createTable tableName="exhibitiondevicegroup">
            <column name="id" type="binary(16)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="name" type="varchar(191)">
                <constraints nullable="false"/>
            </column>
            <column name="exhibition_id" type="binary(16)">
                <constraints nullable="false" foreignKeyName="FK_EXHIBITION_DEVICE_GROUP_EXHIBITION_ID" referencedColumnNames="id" referencedTableName="exhibition"/>
            </column>
            <column name="createdat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="modifiedat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="creatorid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
            <column name="lastmodifierid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="devices" author="antti.leppa">
        <createTable tableName="exhibitiondevice">
            <column name="id" type="binary(16)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="name" type="varchar(191)">
                <constraints nullable="false"/>
            </column>
            <column name="exhibition_id" type="binary(16)">
                <constraints nullable="false" foreignKeyName="FK_EXHIBITION_DEVICE_EXHIBITION_ID" referencedColumnNames="id" referencedTableName="exhibition"/>
            </column>
            <column name="exhibitionDeviceGroup_id" type="binary(16)">
                <constraints nullable="false" foreignKeyName="FK_EXHIBITION_DEVICE_EXHIBITION_DEVICE_GROUP_ID" referencedColumnNames="id" referencedTableName="exhibitiondevicegroup"/>
            </column>
            <column name="locationX" type="double"/>
            <column name="locationY" type="double"/>
            <column name="createdat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="modifiedat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="creatorid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
            <column name="lastmodifierid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="devicemodels" author="antti.leppa">
        <createTable tableName="exhibitiondevicemodel">
            <column name="id" type="binary(16)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="manufacturer" type="varchar(191)">
                <constraints nullable="false"/>
            </column>
            <column name="model" type="varchar(191)">
                <constraints nullable="false"/>
            </column>
            <column name="dimensionWidth" type="double"/>
            <column name="dimensionHeight" type="double"/>
            <column name="resolutionX" type="double"/>
            <column name="resolutionY" type="double"/>
            <column name="capabilityTouch" type="boolean">
                <constraints nullable="false"/>
            </column>
            <column name="exhibition_id" type="binary(16)">
                <constraints nullable="false" foreignKeyName="FK_EXHIBITION_DEVICE_MODEL_EXHIBITION_ID" referencedColumnNames="id" referencedTableName="exhibition"/>
            </column>
            <column name="createdat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="modifiedat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="creatorid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
            <column name="lastmodifierid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addColumn tableName="exhibitiondevice">
            <column name="exhibitionDeviceModel_id" type="binary(16)">
                <constraints nullable="false" foreignKeyName="FK_EXHIBITION_DEVICE_EXHIBITION_DEVICE_MODEL_ID" referencedColumnNames="id" referencedTableName="exhibitiondevicemodel"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="layouts" author="antti.leppa">
        <createTable tableName="exhibitionpagelayout">
            <column name="id" type="binary(16)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="name" type="varchar(191)">
                <constraints nullable="false"/>
            </column>
            <column name="data" type="longtext">
                <constraints nullable="false"/>
            </column>
            <column name="exhibition_id" type="binary(16)">
                <constraints nullable="false" foreignKeyName="FK_EXHIBITION_PAGE_LAYOUT_EXHIBITION_ID" referencedColumnNames="id" referencedTableName="exhibition"/>
            </column>
            <column name="createdat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="modifiedat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="creatorid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
            <column name="lastmodifierid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="pages" author="antti.leppa">
        <createTable tableName="exhibitionpage">
            <column name="id" type="binary(16)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="name" type="varchar(191)">
                <constraints nullable="false"/>
            </column>
            <column name="resources" type="longtext">
                <constraints nullable="false"/>
            </column>
            <column name="events" type="longtext">
                <constraints nullable="false"/>
            </column>
            <column name="eventTriggers" type="longtext">
                <constraints nullable="false"/>
            </column>
            <column name="exhibition_id" type="binary(16)">
                <constraints nullable="false" foreignKeyName="FK_EXHIBITION_PAGE_EXHIBITION_ID" referencedColumnNames="id" referencedTableName="exhibition"/>
            </column>
            <column name="layout_id" type="binary(16)">
                <constraints nullable="false" foreignKeyName="FK_EXHIBITION_PAGE_LAYOUT_ID" referencedColumnNames="id" referencedTableName="exhibitionpagelayout"/>
            </column>
            <column name="createdat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="modifiedat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="creatorid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
            <column name="lastmodifierid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="pagesdropevents" author="antti.leppa">
        <dropColumn tableName="exhibitionpage">
            <column name="events"/>
        </dropColumn>
    </changeSet>

    <changeSet id="nonexhibitionpagelayouts" author="antti.leppa">
        <dropForeignKeyConstraint baseTableName="exhibitionpage" constraintName="FK_EXHIBITION_PAGE_LAYOUT_ID"/>
        <dropForeignKeyConstraint baseTableName="exhibitionpagelayout" constraintName="FK_EXHIBITION_PAGE_LAYOUT_EXHIBITION_ID"/>
        <dropColumn tableName="exhibitionpagelayout" columnName="exhibition_id"/>
        <renameTable oldTableName="exhibitionpagelayout" newTableName="pagelayout" />
        <addForeignKeyConstraint baseTableName="exhibitionpage" baseColumnNames="layout_id" constraintName="FK_EXHIBITION_PAGE_PAGE_LAYOUT_ID" referencedTableName="pagelayout" referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="layoutthumbnailurl" author="antti.leppa">
        <addColumn tableName="pagelayout">
            <column name="thumbnailUrl" type="varchar(191)"/>
        </addColumn>
    </changeSet>

    <changeSet id="devicedisplaymetrics" author="antti.leppa">
        <addColumn tableName="exhibitiondevicemodel">
            <column name="heightPixels" type="INTEGER"/>
            <column name="widthPixels" type="INTEGER"/>
            <column name="density" type="DOUBLE"/>
            <column name="xdpi" type="DOUBLE"/>
            <column name="ydpi" type="DOUBLE"/>
        </addColumn>

        <sql>UPDATE exhibitiondevicemodel set heightPixels = resolutionY</sql>
        <sql>UPDATE exhibitiondevicemodel set widthPixels = resolutionX</sql>

        <dropColumn tableName="exhibitiondevicemodel">
            <column name="resolutionY"/>
        </dropColumn>

        <dropColumn tableName="exhibitiondevicemodel">
            <column name="resolutionX"/>
        </dropColumn>
    </changeSet>

    <changeSet id="screenorientations" author="jari.nykanen">
        <addColumn tableName="exhibitiondevice">
            <column name="screenOrientation" type="varchar(20)" defaultValue="portrait">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <addColumn tableName="pagelayout">
            <column name="screenOrientation" type="varchar(20)" defaultValue="portrait">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="screenorientationdefaults" author="antti.leppa">
        <sql>UPDATE exhibitiondevice SET screenOrientation = 'PORTRAIT'</sql>
        <sql>UPDATE pagelayout SET screenOrientation = 'PORTRAIT'</sql>
        <dropDefaultValue tableName="exhibitiondevice" columnName="screenOrientation" />
        <dropDefaultValue tableName="pagelayout" columnName="screenOrientation" />
    </changeSet>

    <changeSet id="devicemodelsoutofexhibition" author="antti.leppa">
        <dropForeignKeyConstraint baseTableName="exhibitiondevice" constraintName="FK_EXHIBITION_DEVICE_EXHIBITION_DEVICE_MODEL_ID"/>
        <renameColumn tableName="exhibitiondevice" columnDataType="binary(16)" newColumnName="deviceModel_id" oldColumnName="exhibitionDeviceModel_id" />
        <dropForeignKeyConstraint baseTableName="exhibitiondevicemodel" constraintName="FK_EXHIBITION_DEVICE_MODEL_EXHIBITION_ID"/>
        <dropColumn tableName="exhibitiondevicemodel" columnName="exhibition_id"/>
        <renameTable oldTableName="exhibitiondevicemodel" newTableName="devicemodel" />
        <addForeignKeyConstraint baseTableName="exhibitiondevice" baseColumnNames="deviceModel_id" constraintName="FK_EXHIBITION_DEVICE_DEVICE_MODEL_ID" referencedTableName="devicemodel" referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="deviceidtoexhibitionpage" author="jari.nykanen">
        <addColumn tableName="exhibitionpage">
            <column name="device_id" type="binary(16)"/>
        </addColumn>

        <sql>UPDATE exhibitionpage SET device_id = (SELECT ID FROM exhibitiondevice LIMIT 1)</sql>

        <addNotNullConstraint columnDataType="binary(16)" tableName="exhibitionpage" columnName="device_id"/>
        <addForeignKeyConstraint baseTableName="exhibitionpage" baseColumnNames="device_id" constraintName="FK_EXHIBITION_PAGE_DEVICE_ID" referencedTableName="exhibitiondevice" referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="devicedimensionsupdate" author="jari.nykanen">
        <renameColumn tableName="devicemodel" oldColumnName="dimensionWidth" newColumnName="deviceWidth" columnDataType="INTEGER"/>
        <renameColumn tableName="devicemodel" oldColumnName="dimensionHeight" newColumnName="deviceHeight" columnDataType="INTEGER"/>

        <addColumn tableName="devicemodel">
            <column name="deviceDepth" type="INTEGER"/>
            <column name="screenWidth" type="INTEGER"/>
            <column name="screenHeight" type="INTEGER"/>
        </addColumn>
    </changeSet>

    <changeSet id="contentversions" author="antti.leppa">
        <createTable tableName="exhibitioncontentversion">
            <column name="id" type="binary(16)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="name" type="varchar(191)">
                <constraints nullable="false"/>
            </column>
            <column name="exhibition_id" type="binary(16)">
                <constraints nullable="false" foreignKeyName="FK_EXHIBITION_CONTENT_VERSION_EXHIBITION_ID" referencedColumnNames="id" referencedTableName="exhibition"/>
            </column>
            <column name="createdat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="modifiedat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="creatorid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
            <column name="lastmodifierid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addColumn tableName="exhibitionpage">
            <column name="contentVersion_id" type="binary(16)"/>
        </addColumn>
    </changeSet>

    <changeSet id="defaultcontentversions" author="antti.leppa" context="production">
        <sql>INSERT INTO exhibitioncontentversion(id, name, exhibition_id, createdat, modifiedat, creatorid, lastmodifierid) SELECT id, 'default', id, createdat, modifiedat, creatorid, lastmodifierid FROM exhibition</sql>
        <sql>UPDATE exhibitionpage SET contentVersion_id = (SELECT ID FROM exhibitioncontentversion LIMIT 1)</sql>
    </changeSet>

    <changeSet id="pagecontentversionforeignkey" author="antti.leppa">
        <addNotNullConstraint columnDataType="binary(16)" tableName="exhibitionpage" columnName="contentVersion_id"/>
        <addForeignKeyConstraint baseTableName="exhibitionpage" baseColumnNames="contentVersion_id" constraintName="FK_EXHIBITION_PAGE_CONTENT_VERSION_ID" referencedTableName="exhibitioncontentversion" referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="modelidtopagelayout" author="jari.nykanen">
        <addColumn tableName="pagelayout">
            <column name="deviceModel_id" type="binary(16)"/>
        </addColumn>

        <sql>UPDATE pagelayout SET deviceModel_id = (SELECT ID FROM devicemodel LIMIT 1)</sql>

        <addNotNullConstraint columnDataType="binary(16)" tableName="pagelayout" columnName="deviceModel_id"/>
        <addForeignKeyConstraint baseTableName="pagelayout" baseColumnNames="deviceModel_id" constraintName="FK_PAGE_LAYOUT_DEVICE_MODEL_ID" referencedTableName="devicemodel" referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="floors" author="antti.leppa">
        <createTable tableName="exhibitionfloor">
            <column name="id" type="binary(16)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="name" type="varchar(191)">
                <constraints nullable="false"/>
            </column>
            <column name="exhibition_id" type="binary(16)">
                <constraints nullable="false" foreignKeyName="FK_EXHIBITION_FLOOR_EXHIBITION_ID" referencedColumnNames="id" referencedTableName="exhibition"/>
            </column>
            <column name="createdat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="modifiedat" type="datetime(6)">
                <constraints nullable="false"/>
            </column>
            <column name="creatorid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
            <column name="lastmodifierid" type="binary(16)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addColumn tableName="exhibitionroom">
            <column name="floor_id" type="binary(16)"/>
        </addColumn>

        <addColumn tableName="exhibitiondevicegroup">
            <column name="room_id" type="binary(16)"/>
        </addColumn>
    </changeSet>

    <changeSet id="floorsdefaults" author="antti.leppa" context="production">
        <sql>INSERT INTO exhibitionfloor(id, name, exhibition_id, createdat, modifiedat, creatorid, lastmodifierid) SELECT id, 'default', id, createdat, modifiedat, creatorid, lastmodifierid FROM exhibition</sql>
        <sql>UPDATE exhibitionroom SET floor_id = (SELECT ID FROM exhibitionfloor LIMIT 1)</sql>
        <sql>UPDATE exhibitiondevicegroup SET room_id = (SELECT ID FROM exhibitionroom LIMIT 1)</sql>
    </changeSet>

    <changeSet id="floorsforeigns" author="antti.leppa">
        <addNotNullConstraint columnDataType="binary(16)" tableName="exhibitionroom" columnName="floor_id"/>
        <addNotNullConstraint columnDataType="binary(16)" tableName="exhibitiondevicegroup" columnName="room_id"/>

        <addForeignKeyConstraint baseTableName="exhibitionroom"
             baseColumnNames="floor_id"
             constraintName="FK_EXHIBITION_ROOM_FLOOR_ID"
             referencedTableName="exhibitionfloor"
             referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="exhibitiondevicegroup"
             baseColumnNames="room_id"
             constraintName="FK_EXHIBITION_DEVICE_GROUP_ROOM_ID"
             referencedTableName="exhibitionroom"
             referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="exhibitiondeviceindexpage" author="antti.leppa">
        <addColumn tableName="exhibitiondevice">
            <column name="indexPage_id" type="binary(16)">
                <constraints nullable="true" foreignKeyName="FK_EXHIBITION_DEVICE_INDEX_PAGE_ID" referencedColumnNames="id" referencedTableName="exhibitionpage"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="floorplanurl" author="jari.nykanen">
        <addColumn tableName="exhibitionfloor">
            <column name="floorPlanUrl" type="varchar(191)"/>
        </addColumn>
    </changeSet>

    <changeSet id="roompolygon" author="jari.nykanen">
        <addColumn tableName="exhibitionroom">
            <column name="geoShape" type="longtext"/>
        </addColumn>
    </changeSet>

    <changeSet id="geobounds" author="jari.nykanen">
        <addColumn tableName="exhibitionfloor">
            <column name="swBoundPoint" type="Geometry"/>
            <column name="neBoundPoint" type="Geometry"/>
        </addColumn>
    </changeSet>

    <changeSet id="pagetransitions" author="antti.leppa">
        <addColumn tableName="exhibitionpage">
            <column name="enterTransitions" type="longtext"/>
        </addColumn>

        <addColumn tableName="exhibitionpage">
            <column name="exitTransitions" type="longtext"/>
        </addColumn>
    </changeSet>

</databaseChangeLog>